<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "7622aa72f9e676e593339f5f694ecd7d",
  "translation_date": "2025-06-11T04:54:22+00:00",
  "source_file": "05-agentic-rag/README.md",
  "language_code": "ja"
}
-->
[![Agentic RAG](../../../05-agentic-rag/images/lesson-5-thumbnail.png)](https://youtu.be/WcjAARvdL7I?si=BCgwjwFb2yCkEhR9)

> _(上の画像をクリックするとこのレッスンの動画が見られます)_

# Agentic RAG

このレッスンでは、Agentic Retrieval-Augmented Generation（Agentic RAG）について詳しく解説します。Agentic RAGは、大規模言語モデル（LLM）が外部情報を参照しながら自律的に次の行動を計画する新しいAIのパラダイムです。従来の静的な「検索して読む」パターンとは異なり、Agentic RAGはLLMへの反復的な呼び出しを含み、その間にツールや関数の呼び出し、構造化された出力が挟まれます。システムは結果を評価し、クエリを改善し、必要に応じて追加のツールを呼び出し、このサイクルを満足のいく解決策が得られるまで続けます。

## はじめに

このレッスンでは以下を学びます。

- **Agentic RAGの理解:** 大規模言語モデル（LLM）が外部データから情報を引き出しながら自律的に次のステップを計画する新しいAIパラダイムについて学びます。
- **反復的なメーカー・チェッカースタイルの理解:** ツールや関数の呼び出し、構造化出力を挟みながらLLMを反復的に呼び出すループを理解し、正確性の向上や誤ったクエリの処理方法を把握します。
- **実践的な応用例の探求:** Agentic RAGが活躍する場面、例えば正確性重視の環境、複雑なデータベース操作、長期的なワークフローなどを特定します。

## 学習目標

このレッスンを終えると、以下を理解・習得できます。

- **Agentic RAGの理解:** LLMが外部データから情報を取得しつつ自律的に次の行動を計画する新しいAIパラダイムを学ぶ。
- **反復的なメーカー・チェッカースタイル:** ツールや関数の呼び出し、構造化出力を挟みながらLLMを反復的に呼び出すループの概念を理解し、正確性の向上や誤ったクエリの処理方法を把握する。
- **推論プロセスの所有:** システムがあらかじめ決められた経路に依存せず、自ら問題解決の方法を決定する能力を理解する。
- **ワークフロー:** エージェントモデルが市場動向レポートを取得し、競合データを特定し、社内販売指標を相関分析し、結果を統合して戦略を評価する一連の流れを理解する。
- **反復ループ、ツール統合、メモリ:** 状態と記憶を維持しながら反復的にやりとりを行い、同じループの繰り返しを避け、情報に基づいた判断を下すシステムの仕組みを学ぶ。
- **失敗モードの処理と自己修正:** 反復や再クエリ、診断ツールの活用、人間の監督へのフォールバックなど、堅牢な自己修正メカニズムを探る。
- **エージェンシーの限界:** Agentic RAGの限界、特にドメイン固有の自律性、インフラ依存、ガードレールの尊重について理解する。
- **実用的なユースケースと価値:** 正確性重視の環境、複雑なデータベース操作、長期的なワークフローなど、Agentic RAGが効果を発揮するシナリオを特定する。
- **ガバナンス、透明性、信頼:** 説明可能な推論、バイアス制御、人間の監督など、ガバナンスと透明性の重要性を学ぶ。

## Agentic RAGとは？

Agentic Retrieval-Augmented Generation（Agentic RAG）は、大規模言語モデル（LLM）が外部情報を参照しながら自律的に次の行動を計画する新たなAIパラダイムです。静的な「検索して読む」パターンとは異なり、Agentic RAGはLLMへの反復的な呼び出しを含み、その間にツールや関数の呼び出し、構造化された出力が挟まれます。システムは結果を評価し、クエリを改善し、必要に応じて追加のツールを呼び出し、このサイクルを満足のいく解決策が得られるまで続けます。この反復的な「メーカー・チェッカー」スタイルにより、正確性が向上し、誤ったクエリの処理が可能となり、高品質な結果が保証されます。

システムは自らの推論プロセスを主体的に管理し、失敗したクエリを書き直したり、異なる検索手法を選択したり、Azure AI Searchのベクトル検索、SQLデータベース、カスタムAPIなど複数のツールを統合して最終回答を導き出します。Agenticシステムの特徴は、この推論プロセスを自律的に所有する能力にあります。従来のRAG実装は事前に決められた経路に依存しますが、Agenticシステムは得られた情報の質に基づいて自律的に手順を決定します。

## Agentic Retrieval-Augmented Generation（Agentic RAG）の定義

Agentic Retrieval-Augmented Generation（Agentic RAG）は、LLMが外部データソースから情報を取得するだけでなく、自律的に次のステップを計画するAI開発の新しいパラダイムです。静的な「検索して読む」パターンや厳密にスクリプト化されたプロンプトシーケンスとは異なり、Agentic RAGはLLMへの反復的な呼び出しループを含み、その間にツールや関数の呼び出し、構造化出力が挟まれます。システムは毎回得られた結果を評価し、クエリを改善すべきか判断し、必要に応じて追加のツールを呼び出し、満足のいく解決策が得られるまでこのサイクルを続けます。

この反復的な「メーカー・チェッカー」スタイルは、正確性の向上、誤ったクエリの処理（例：NL2SQLのような構造化データベースへのクエリ）、バランスの取れた高品質な結果の保証を目的としています。単に精巧に設計されたプロンプトチェーンに頼るのではなく、システムは推論プロセスを主体的に管理します。失敗したクエリを書き直し、異なる検索手法を選択し、Azure AI Searchのベクトル検索、SQLデータベース、カスタムAPIなど複数のツールを統合して最終回答を導き出します。これにより、過度に複雑なオーケストレーションフレームワークを必要とせず、「LLM呼び出し → ツール使用 → LLM呼び出し → …」という比較的シンプルなループで高度かつ根拠のある出力が得られます。

![Agentic RAG Core Loop](../../../05-agentic-rag/images/agentic-rag-core-loop.png)

## 推論プロセスの所有

システムを「Agentic」と呼ぶ最大の特徴は、自らの推論プロセスを主体的に所有する能力にあります。従来のRAG実装では、人間がモデルのために取得すべき情報やタイミングを示したチェーン・オブ・ソートを事前に定義することが多いです。
しかし真にAgenticなシステムは、内部で問題へのアプローチ方法を決定します。単にスクリプトを実行するのではなく、得られた情報の質に基づき自律的に手順の順序を決定します。
例えば、製品ローンチ戦略の作成を依頼された場合、全ての調査と意思決定のワークフローを明示したプロンプトに依存するのではなく、Agenticモデルは以下を独自に判断します。

1. Bing Web Groundingを使って最新の市場動向レポートを取得する
2. Azure AI Searchを使って関連する競合データを特定する
3. Azure SQL Databaseを使って過去の社内販売指標を相関分析する
4. Azure OpenAI Serviceを通じて調査結果を統合し、一貫した戦略を策定する
5. 戦略のギャップや矛盾を評価し、必要に応じて再度情報取得を行う
これらすべてのステップは、クエリの洗練、情報源の選択、「満足」するまでの反復など、モデル自身が決定し、人間が事前にスクリプト化したものではありません。

## 反復ループ、ツール統合、メモリ

![Tool Integration Architecture](../../../05-agentic-rag/images/tool-integration.png)

Agenticシステムは反復的なインタラクションパターンに依存しています。

- **初回呼び出し:** ユーザーの目的（ユーザープロンプト）がLLMに渡されます。
- **ツール呼び出し:** モデルが情報不足や曖昧な指示を検知すると、ベクトルデータベースクエリ（例：Azure AI Searchのプライベートデータに対するハイブリッド検索）や構造化SQL呼び出しなどのツールや検索手法を選択して追加情報を取得します。
- **評価と改善:** 返されたデータを検討し、情報が十分か判断します。不十分な場合はクエリを洗練し、別のツールを試すかアプローチを調整します。
- **満足するまで繰り返し:** モデルが最終的に十分な明確さと証拠を得て、良く推論された回答を出せると判断するまでこのサイクルを続けます。
- **メモリと状態:** システムはステップ間で状態と記憶を保持するため、過去の試行や結果を思い出し、無駄なループを避けつつ、より良い判断を下せます。

この仕組みにより、モデルは進化する理解を持つかのように複雑で多段階のタスクをこなし、人間が常に介入してプロンプトを調整する必要がなくなります。

## 失敗モードの処理と自己修正

Agentic RAGの自律性には堅牢な自己修正メカニズムも含まれます。システムが行き詰まった場合（無関係な文書を取得したり、誤ったクエリに遭遇したりしたとき）には以下の対応を行います。

- **反復と再クエリ:** 低品質な回答を返す代わりに、新たな検索戦略を試したり、データベースクエリを書き直したり、別のデータセットを参照します。
- **診断ツールの利用:** 推論の過程をデバッグしたり、取得データの正確性を確認するための追加機能を呼び出します。Azure AI Tracingのようなツールは堅牢な可観測性と監視を可能にします。
- **人間の監督へのフォールバック:** 重要度が高い場合や繰り返し失敗する場合は、不確実性を示して人間の指導を求めます。人間の修正フィードバックを受けて以降の動作に反映します。

この反復的かつ動的なアプローチにより、モデルは継続的に改善し、一度きりのシステムではなく、セッション中の失敗から学習する仕組みを持ちます。

![Self Correction Mechanism](../../../05-agentic-rag/images/self-correction.png)

## エージェンシーの限界

Agentic RAGはタスク内で自律的に動作しますが、汎用人工知能（AGI）とは異なります。その「エージェンシー」能力は、人間の開発者が提供したツール、データソース、ポリシーの範囲内に限定されます。独自にツールを発明したり、設定されたドメインの境界を超えたりはできません。むしろ、手元のリソースを動的にオーケストレーションすることに長けています。
より高度なAI形態との主な違いは以下の通りです。

1. **ドメイン固有の自律性:** Agentic RAGシステムは既知のドメイン内でユーザー定義の目標を達成することに特化しており、クエリの書き換えやツール選択などの戦略を用いて成果を向上させます。
2. **インフラ依存:** システムの能力は開発者が統合したツールやデータに依存し、人間の介入なしにこれらの境界を超えることはできません。
3. **ガードレールの尊重:** 倫理ガイドライン、コンプライアンスルール、ビジネスポリシーは非常に重要であり、エージェントの自由度は安全措置や監督メカニズムによって常に制約されています（願わくば）。

## 実用的なユースケースと価値

Agentic RAGは反復的な洗練と精度が求められるシナリオで特に有効です。

1. **正確性重視の環境:** コンプライアンスチェック、規制分析、法律調査などで、エージェントモデルは事実を繰り返し検証し、複数の情報源を参照し、クエリを書き直して徹底的に検証された回答を導きます。
2. **複雑なデータベース操作:** 構造化データを扱う際にクエリが失敗しやすい場合、Azure SQLやMicrosoft Fabric OneLakeを用いて自律的にクエリを洗練し、最終的な取得結果がユーザーの意図に合致するようにします。
3. **長期的なワークフロー:** セッションが長引き新たな情報が出てくる場合、Agentic RAGは継続的にデータを取り込み、問題領域の理解が深まるにつれて戦略を変化させます。

## ガバナンス、透明性、信頼

これらのシステムが推論をより自律的に行うようになるにつれ、ガバナンスと透明性が極めて重要になります。

- **説明可能な推論:** モデルは行ったクエリ、参照した情報源、結論に至るまでの推論ステップの監査証跡を提供できます。Azure AI Content SafetyやAzure AI Tracing / GenAIOpsのようなツールが透明性の維持とリスク軽減に役立ちます。
- **バイアス制御とバランスの取れた検索:** 開発者は検索戦略を調整してバランスの取れた代表的なデータソースを考慮し、Azure Machine Learningを使った高度なデータサイエンス組織向けのカスタムモデルで出力を定期的に監査し、バイアスや偏りを検出します。
- **人間の監督とコンプライアンス:** 敏感なタスクでは人間のレビューが不可欠です。Agentic RAGは高リスクの意思決定における人間の判断を置き換えるのではなく、より徹底的に検証された選択肢を提供して補完します。

行動の記録を明確に残すツールがあることが必須です。これがなければ、多段階プロセスのデバッグは非常に困難になります。以下はLiteral AI（Chainlitの開発元）によるAgent実行例です。

![AgentRunExample](../../../05-agentic-rag/images/AgentRunExample.png)

![AgentRunExample2](../../../05-agentic-rag/images/AgentRunExample2.png)

## まとめ

Agentic RAGは、AIシステムが複雑で大量のデータを扱うタスクを処理する方法の自然な進化を示しています。反復的なインタラクションパターンを採用し、自律的にツールを選択し、クエリを洗練して高

**免責事項**：  
本書類はAI翻訳サービス[Co-op Translator](https://github.com/Azure/co-op-translator)を使用して翻訳されています。正確性には努めておりますが、自動翻訳には誤りや不正確な部分が含まれる可能性があることをご了承ください。原文の言語によるオリジナルの文書が正式な情報源とみなされます。重要な情報については、専門の人間による翻訳を推奨します。本翻訳の使用により生じたいかなる誤解や解釈の相違についても、一切の責任を負いかねます。